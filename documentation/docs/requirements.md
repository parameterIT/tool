# Overview
_Modu_ uses _Poetry_ to install the majority of the requirements needed. To run _Modu_, these are the only dependencies needed. 

_Modu_ currently supports a re-creation of the quality model that Code Climate makes use of, but will require the addition of a couple of external dependencies.

## Installing poetry and dependencies
### Python
Our tool will require a user to have a python version of 3.10 or higher. Please ensure that you are making use of an appropriate python version
### Python Poetry
As mentioned before, _Modu_ makes use of _Poetry_ to manage the majority of our dependencies. Please refer to the poetry documentation on how to install it: https://python-poetry.org/docs/

### GitHub Linguist

We use [GitHub Linguist v7.25.0](https://github.com/github/linguist/tree/v7.25.0) to detect the language of source files.
To execute GitHub Linguist we use [Docker >= 23.0.4](https://docs.docker.com/), so make sure to pull the docker image `tofferantor/linguist`:

```shell
docker pull tofferantor/linguist
```

### Tree-sitter
_Tree-sitter_ is used for generating abstract syntax tree that can be used for querying specific node types. _Tree-sitter_ requires specifically built grammar types for each coding language analyzed. These grammars can be generated by doing the following: 

Ensure that you are in the **tool** folder. 
```
tool/
    ...
    documentation/
    figures/
    modu/
    ...
```

Run the following commands:
Generation of build and grammars folder:
```sh
mkdir -p build grammars
```
Clone the different grammars into grammars/:
```sh
cd grammars && git clone https://github.com/tree-sitter/tree-sitter-python && git clone https://github.com/tree-sitter/tree-sitter-c-sharp && git clone https://github.com/tree-sitter/tree-sitter-java && cd -
```
Build the grammar file:
```sh
poetry run python core/build_treesitter.py
```

**Adding new languages**

If you want to expand on the current capabilities of the program by adding a new supported language, you will need to do the following: 
Addding a new language to the grammars folder (please refer to the _Tree-sitter_ documentation to see supported languages: https://tree-sitter.github.io/tree-sitter/):
```sh
cd grammars && git clone https://github.com/tree-sitter/tree-sitter-<some-supported-language> && cd -
```
Adding new grammar to build command: 
```sh
cd core
vim build_treesitter.py
-------------------------
Language.build_library(
    "build/my-languages.so",
    [
        "grammars/tree-sitter-python",
        "grammars/tree-sitter-c-sharp",
        "grammars/tree-sitter-java",
        "grammars/<your-new-language>"
    ],
)
--------------------------
```
Adding the parser to the source repository (global statement and init method):
```py
PYTHON = "python"
C_SHARP = "c_sharp"
JAVA = "java"
<YOUR_NEW_LANGUAGE> = "<tree_sitters_supported_language>"
UNKNOWN_LANGUAGE = "unknown"
... 
class SourceRepository:
    """
    contains all information accessible by metrics about the source code
    under analysis
    """

    def __init__(self, src_root: Path):
        self.src_root: Path = src_root
        self.asts: Dict[Path, tree_sitter.Tree] = {}
        self.files: Dict[Path, FileInfo] = self._discover_files()
        self.tree_sitter_languages: Dict[str, tree_sitter.Language] = {
            PYTHON: tree_sitter.Language(_TREESITTER_BUILD, PYTHON),
            C_SHARP: tree_sitter.Language(_TREESITTER_BUILD, C_SHARP),
            JAVA: tree_sitter.Language(_TREESITTER_BUILD, JAVA),
            <YOUR_NEW_LANGUAGE>: tree_sitter.Language(_TREESITTER_BUILD, <YOUR_NEW_LANGUAGE>),
        }

        python_parser = tree_sitter.Parser()
        python_parser.set_language(self.tree_sitter_languages[PYTHON])

        c_sharp_parser = tree_sitter.Parser()
        c_sharp_parser.set_language(self.tree_sitter_languages[C_SHARP])

        java_parser = tree_sitter.Parser()
        java_parser.set_language(self.tree_sitter_languages[JAVA])

        <YOUR_NEW_LANGUAGE>_parser = tree_sitter.Parser()
        <YOUR_NEW_LANGUAGE>_parser.set_language(self.tree_sitter_languages[<YOUR_NEW_LANGUAGE>])

        self.tree_sitter_parsers: Dict[str, tree_sitter.Parser] = {
            PYTHON: python_parser,
            <YOUR_NEW_LANGUAGE>: <YOUR_NEW_LANGUAGE>_parser,
            JAVA: java_parser,
        }
    ...
```
## Other dependencies (Code Climate Implementation)
### PMD - Copy Paste Detector (CPD)
Part of implementing code climate was finding the amount of similar and identical code blocks. We managed this by using an external tool called PMD or more specifically Copy Paste Detector (CPD) - https://docs.pmd-code.org/latest/index.html

We made use of the 6.54.0 (January 2023) version, and would encourage any user to do the same. In case this version is deprecated, new releases can be found at: https://github.com/pmd/pmd/releases

Now download the bin zip folder - e.g. pmd-bin-6.54.0.zip
This folder will contain two sub folders - bin and lib. 

Now run the following command: 
```sh
mkdir cpd && mkdir cpd/bin cpd/lib
```
Please ensure that your folder structure looks like the following: 
```
tool/
    ...
    modu/
    metrics/
        cpd/
            bin/
            lib/
    ...
```
Finally extract the bin and lib folder files from before into their respective folders.
